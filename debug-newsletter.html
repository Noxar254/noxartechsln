<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #logs { background: #f5f5f5; padding: 10px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Newsletter Subscription Debug</h1>
    
    <div class="debug-section">
        <h3>Firebase Status</h3>
        <div id="firebase-status">Checking...</div>
    </div>
    
    <div class="debug-section">
        <h3>Test Newsletter Subscription</h3>
        <form id="testForm">
            <input type="email" id="testEmail" placeholder="test@example.com" value="test@example.com">
            <button type="submit">Test Subscribe</button>
        </form>
        <div id="test-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>Actual Newsletter Form (Copy from index.html)</h3>
        <form class="subscription-form" id="newsletterForm">
            <div class="form-group">
                <input type="email" id="newsletterEmail" name="email" placeholder="Enter your email address" required>
                <button type="submit" class="subscribe-btn">
                    Subscribe <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
        <div id="newsletter-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>Debug Logs</h3>
        <div id="logs"></div>
    </div>

    <!-- Firebase SDK CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script>
        // Debug logging
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWPrCiuY9yjvQMGiGzBDtndAa2FCLBX78",
            authDomain: "noxartechsln.firebaseapp.com",
            projectId: "noxartechsln",
            storageBucket: "noxartechsln.firebasestorage.app",
            messagingSenderId: "950592446485",
            appId: "1:950592446485:web:f4642f47cbbb3888b0ee1c",
            measurementId: "G-RT8E110P82"
        };

        let db, analytics;
        let isFirebaseReady = false;

        // Initialize Firebase
        try {
            log('Initializing Firebase...');
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            analytics = firebase.analytics();
            isFirebaseReady = true;
            log('✅ Firebase initialized successfully', 'success');
            document.getElementById('firebase-status').innerHTML = '<span class="success">✅ Firebase Connected</span>';
        } catch (error) {
            log('❌ Firebase initialization failed: ' + error.message, 'error');
            document.getElementById('firebase-status').innerHTML = '<span class="error">❌ Firebase Failed: ' + error.message + '</span>';
        }

        // Newsletter subscription function
        window.submitNewsletterSubscription = async function(email) {
            try {
                log(`Starting newsletter subscription for: ${email}`);
                
                if (!isFirebaseReady) {
                    throw new Error('Firebase not initialized');
                }
                
                if (!db) {
                    throw new Error('Firestore not available');
                }
                
                log('Adding document to Firestore...');
                const docRef = await db.collection('newsletter-subscriptions').add({
                    email: email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "active",
                    source: "website",
                    userAgent: navigator.userAgent,
                    subscriptionTime: Date.now()
                });

                log(`✅ Newsletter subscription submitted with ID: ${docRef.id}`, 'success');
                
                // Track successful subscription
                if (analytics) {
                    analytics.logEvent('newsletter_subscribed', {
                        subscription_time: Date.now()
                    });
                    log('Analytics event logged', 'success');
                }

                return { success: true, id: docRef.id };
            } catch (error) {
                log(`❌ Newsletter subscription error: ${error.message}`, 'error');
                
                // Track errors
                if (analytics) {
                    analytics.logEvent('newsletter_subscription_error', {
                        error_message: error.message
                    });
                }
                
                return { success: false, error: error.message };
            }
        };

        // Test form handler
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('testEmail').value;
            const resultDiv = document.getElementById('test-result');
            
            log(`Testing direct subscription for: ${email}`);
            resultDiv.innerHTML = 'Testing...';
            
            try {
                const result = await window.submitNewsletterSubscription(email);
                if (result.success) {
                    resultDiv.innerHTML = `<span class="success">✅ Success! ID: ${result.id}</span>`;
                    log(`✅ Test subscription successful: ${result.id}`, 'success');
                } else {
                    resultDiv.innerHTML = `<span class="error">❌ Failed: ${result.error}</span>`;
                    log(`❌ Test subscription failed: ${result.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
                log(`❌ Test subscription error: ${error.message}`, 'error');
            }
        });

        // Load the actual script.js to test NewsletterManager
        const script = document.createElement('script');
        script.src = 'script.js';
        script.onload = () => {
            log('✅ script.js loaded successfully', 'success');
        };
        script.onerror = () => {
            log('❌ Failed to load script.js', 'error');
        };
        document.head.appendChild(script);

        log('Debug page initialized');
    </script>
</body>
</html>
